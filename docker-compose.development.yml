version: '3.4'
services:
  db:
    # using latest (8.x.x) mysql cause below error:
    # mbind: Operation not permitted
    # workaround: https://github.com/docker-library/mysql/issues/303
    # - use older version
    image: mysql:5.7.28
    environment: 
      MYSQL_DATABASE: sts_blogs_dev
      MYSQL_USER: sts
      MYSQL_PASSWORD: sts1551@IWO
      MYSQL_ROOT_PASSWORD: sts1551@IWO
    volumes:
     - '$PWD/Db/docker-entrypoint-initdb.d/:/docker-entrypoint-initdb.d/'
  webserver:
    build: 
      context: './Spa'
      target: staging
    environment:
      - NODE_ENV=staging 
    env_file:
      - "./Spa/.env.prod"
    volumes:
      - "$PWD/WebServer/default.conf:/etc/nginx/conf.d/default.conf:ro"
    ports: 
      - "80:80"
    depends_on:
      - api1
  api1:
    build: 
      context: './Api1'
      target: development
    # image: api1:dev
    volumes:
      - "$PWD/Api1/:/app"
    env_file:
      - './Api1/.env.development'
    environment:
      - FLASK_ENV=development
      - FLASK_APP=./run.py
    ports: 
      - "5000:5000"
    depends_on:
      - db
#  web-server: 
#    image: nginx
#    volumes:
#      - "$PWD/WebServer/default.conf:/etc/nginx/conf.d/default.conf:ro"
#    ports: 
#      - "8080:80"
  # db: in-memory in dev
